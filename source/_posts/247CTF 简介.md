---

Author: 喝点聊聊
title: 247CTF
date: 2020-04-26 18:40:02
categories: 

- CTF

---

## 247CTF 简介

* 解题网站，题目独立，按类别分类

* 注册与登录需要调用``google``的验证码服务

  ![register](/public/blog-imgs/247ctf_reg.png)

## Beginner

### TIPS AND TRICKS

#### Instruction
​	There's a server listening on some tcp port. When a new connection comes in, it responces with a text containing a math addition problem. The client will receive the flag after it answers correctly for the whole 500 questions.

#### Analysis

​	It's unrealistic to send answers by hand, so we should write a simple client which reads questions, computes answers and sends back, over and over again.

``` python
import socket
s = socket.socket(2, 1)
host = '728d1bbe8df32a68.247ctf.com'
port = 50277
s.connect((host, port))

for i in range(500):
    msg = s.recv(1024)
    print(msg)
    ques = msg.decode('utf-8').split('\r\n')[-2]
    segs = ques.split(' ')
    a = int(segs[-3])
    b = int(segs[-1][0:-1])
    print(a+b)
    
    # attention! '\r\n' should be added, simulating a person pressing enter key.
    s.send((str(a+b)+'\r\n').encode('utf-8')) 

flag = s.recv(1024).decode()
print(flag)
s.close()

```
#### Reference

* [Python socket module](https://www.bladewan.com/2017/10/01/python_socket/)







## Networking
### ERROR REPORTING PROTOCOL
#### Instruction
​    Download the tcpdump file and identify the flag hidden within the error messages of this ICMP traffic.

#### Analysis

1. Find where and what the error is.
    ![01](/public/blog-imgs/247ctf/01.png)

2. Why error ?

   In `echo(ping)`, `ICMP` uses `id` and `seq` to identify and match request and reply. Also, `ICMP` will try to match the `data` field between request and reply. Under default setting, those two data field are the same , as the name `echo` imply. So, if there is not a match for some req, it reports a warning.

3. What to do ? 

   Data in echo reply changed, so maybe some information is hidden in the payload. In Wireshark we can see the payload in echo request is "Send the flag !", and payload in the first reply have "JFIF" in it, which means reply is an image.
    ![02](/public/blog-imgs/247ctf/02.png)
    ![03](/public/blog-imgs/247ctf/03.png)
   Now we should concatenate all ICMP reply payloads to one file.

```python
# python3
import dpkt

in_pcap=open("error_reporting.pcap", "rb")

# going to extract all ICMP payloads and concatenate them in_pcap one file
output=open("output.jpg", "bw")
pcap=dpkt.pcap.Reader(in_pcap)

# The parsed packets in the dpkt.pcap.Reader contains two members: "ts" and "buf".
# The member "ts" is just the timestamp which lived in_pcap the packet when captured
# by Wireshark; it is the clock when captured this packet. The member "buf" holds
# the real packet data captured by capture tool, it's the raw traffic data.
for ts, buf in pcap:
    eth=dpkt.ethernet.Ethernet(buf)
    if (eth.type != 2048): # 2048 is the code for IPv4
        continue

    ip=eth.data
    icmp=ip.data

    if (ip.p==dpkt.ip.IP_PROTO_ICMP) and len(icmp.data.data)>0:
        output.write(icmp.data.data)


in_pcap.close()
output.close()

```

Now we get the img and can see flag after opening it .

#### Reference

* (https://docs.microsoft.com/zh-cn/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho?redirectedfrom=MSDN)
* [dpkt解题](https://b4d.sablun.org/blog/2020-02-16-247ctf-com-networking-error-reporting-protocol/)
* 